# Keitaro to Yandex.Metrika CAPI Handler

Этот набор PHP-скриптов предназначен для организации серверной передачи данных о конверсиях (лидах и продажах) из трекера Keitaro в API Яндекс.Метрики (CDP Events API).
Подробная статья тут
https://deliveryalc.online/keitaro-yandex-metrika-api-conversion-gateway

Решение позволяет связать офлайн-конверсию (полученную через S2S-постбэк от партнерской сети) с конкретным посетителем сайта, используя его `ClientID` из Яндекс.Метрики.

## Особенности

-   **Только Яндекс.Метрика:** Код полностью очищен от логики других систем аналитики.
-   **Привязка по ClientID:** Используется самый надежный метод для связи конверсии с визитом пользователя.
-   **Поддержка разных статусов:** Корректно обрабатывает статусы `lead` и `sale`.
-   **Передача ценности:** Для продаж автоматически передается доход и валюта.
-   **Подробное логирование:** Каждая транзакция записывается в текстовый лог-файл, который можно просмотреть через веб-интерфейс.
-   **Чистая архитектура:** Настройки, логика и отображение логов разделены на разные файлы.

## Схема Работы

1.  **Пользователь** попадает на ваш **Прелендинг**.
2.  На прелендинге срабатывает счетчик Яндекс.Метрики и JavaScript-код.
3.  **JavaScript** получает `ClientID` (`_ym_uid`) пользователя и автоматически добавляет его в виде `&sub_id_16=...` ко всем исходящим ссылкам, ведущим на кампанию Keitaro.
4.  **Keitaro** принимает клик, сохраняет `sub_id_16` и перенаправляет пользователя на **Оффер** партнерской сети.
5.  Пользователь совершает конверсию на стороне партнерской сети.
6.  **Партнерская сеть** отправляет S2S-постбэк в Keitaro, возвращая `sub_id` клика и `sub_id_16` с ClientID.
7.  **Keitaro**, получив постбэк, вызывает наш скрипт **`handler.php`**, передавая ему все необходимые данные.
8.  **`handler.php`** отправляет событие в API Яндекс.Метрики, используя `ClientID` для привязки.

## Установка и Настройка

### Шаг 1: Размещение файлов

Скопируйте три файла (`config.php`, `handler.php`, `index.php`) в папку вашего локального лендинга в Keitaro. Например, если ваш лендинг имеет ID `2`, путь будет:
`/var/www/keitaro/landers/2/`

### Шаг 2: Настройка Прелендинга

Добавьте следующий JavaScript-код на ваш прелендинг перед закрывающим тегом `</body>`.

```javascript
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function () {
    // ЗАМЕНИТЕ НА ВАШ ID СЧЕТЧИКА ЯНДЕКС.МЕТРИКИ
    const ymCounterId = 12345678; 

    const clientIdParam = 'sub_id_16';

    function appendClientIdToLinks(clientId) {
        // Рекомендуется добавить ссылкам на Keitaro специальный класс, например "keitaro-link"
        const links = document.querySelectorAll('a.keitaro-link'); 

        links.forEach(function(link) {
            try {
                const url = new URL(link.href);
                url.searchParams.set(clientIdParam, clientId);
                link.href = url.toString();
            } catch (e) {
                // Игнорируем ошибки для невалидных URL
            }
        });
    }

    if (typeof ym === 'function') {
        ym(ymCounterId, 'getClientID', function(clientId) {
            if (clientId) {
                appendClientIdToLinks(clientId);
            }
        });
    }
});
</script>
```

### Шаг 3: Настройка `config.php`

Откройте файл `config.php` и укажите ваши данные:

-   `YM_COUNTER_ID`: ID вашего счетчика в Яндекс.Метрике.
-   `YM_OAUTH_TOKEN`: Ваш OAuth-токен для доступа к API. **Важно:** токен должен иметь права на `metrika:write_cdp_data`.

### Шаг 4: Настройка Постбэков в Keitaro

В вашей кампании Keitaro настройте S2S-постбэки.

**URL для Лидов (Leads):**
```
http://127.0.0.1/landers/2/handler.php?status=lead&yclid={yclid}&sub_id_16={sub_id_16}
```

**URL для Продаж (Sales):**
```
http://127.0.0.1/landers/2/handler.php?status=sale&payout={payout}&currency={currency}&yclid={yclid}&sub_id_16={sub_id_16}
```
*Замените `127.0.0.1` на ваш домен, если Keitaro и скрипт находятся на разных серверах.*

## Логирование

-   **Просмотр логов:** Откройте в браузере URL `http://ВАШ_ДОМЕН/landers/2/index.php`.
-   **Файл логов:** Все транзакции записываются в файл `yandex_log.txt`, который создается автоматически в той же папке.
-   **Ответы Яндекса:** В логах вы увидите полный ответ от API Яндекса, что полезно для отладки. Успешный ответ обычно содержит `"uploading_status": "OK"`.

## Возможные Проблемы

-   **Ошибка "ClientID is missing"**: Убедитесь, что ваш JS-код на прелендинге корректно работает и что партнерская сеть возвращает `sub_id_16` в постбэке.
-   **Ошибка 403 (Forbidden) от Яндекса**: Проверьте, что ваш `YM_OAUTH_TOKEN` действителен и имеет необходимые права (`metrika:write_cdp_data`).
-   **Ошибка 400 (Bad Request) от Яндекса**: Проверьте правильность ID счетчика (`YM_COUNTER_ID`).
